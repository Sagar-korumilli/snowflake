name: Deploy to Snowflake

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install SnowCLI
        run: |
          pip install --user snowflake-cli
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure SnowCLI
        run: |
          mkdir -p ~/.snowflake
          cat << EOF > ~/.snowflake/config.toml
          [connections.default]
          account = "iiljdbv-rv91789"
          user = "SAGARK"
          password = "Infyme@25011998"
          role = "ACCOUNTADMIN"
          database = "DEVOPS"
          warehouse = "COMPUTE_WH"
          EOF
          chmod 600 ~/.snowflake/config.toml

      - name: Test Snowflake Connection
        run: snow connection test --connection default

      - name: Deploy schemas (CREATE SCHEMA statements)
        run: |
          echo "Creating schemas..."
          snow sql -f scripts/*.sql --connection default

      - name: Deploy TABLES
        run: |
          echo "Deploying TABLES..."
          find schemas -type f -path "*/tables/*.sql" | sort | while read file; do
            echo "Deploying $file"
            snow sql -f "$file" --connection default
          done

      - name: Deploy FUNCTIONS
        run: |
          echo "Deploying FUNCTIONS..."
          find schemas -type f -path "*/functions/*.sql" | sort | while read file; do
            echo "Deploying $file"
            snow sql -f "$file" --connection default
          done

      - name: Deploy PROCEDURES
        run: |
          echo "Deploying PROCEDURES..."
          find schemas -type f -path "*/procedures/*.sql" | sort | while read file; do
            echo "Deploying $file"
            snow sql -f "$file" --connection default
          done

      - name: Deploy VIEWS
        run: |
          echo "Deploying VIEWS..."
          find schemas -type f -path "*/views/*.sql" | sort | while read file; do
            echo "Deploying $file"
            snow sql -f "$file" --connection default
          done
