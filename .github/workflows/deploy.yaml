name: Deploy to Snowflake on PR Merge

on:
  pull_request:
    types: [closed]

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set environment variables
        run: |
          echo "BASE_SHA=${{ github.event.pull_request.base.sha }}" >> $GITHUB_ENV
          echo "HEAD_SHA=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV

      - name: Get changed SQL files
        id: detect_changes
        run: |
          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA | grep '\.sql$' || true)
          echo "Changed SQL files:"
          echo "$CHANGED_FILES"

          if [[ -z "$CHANGED_FILES" ]]; then
            echo "DEPLOY_ALL=true" >> $GITHUB_ENV
          else
            echo "$CHANGED_FILES" > changed_files.txt
            echo "DEPLOY_ALL=false" >> $GITHUB_ENV
          fi

      - name: Set up Python and SnowCLI
        run: |
          pip install --user snowflake-cli
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure SnowCLI
        run: |
          mkdir -p ~/.snowflake
          cat <<EOF > ~/.snowflake/config.toml
          [connections.default]
          account = "iiljdbv-rv91789"
          user = "SAGARK"
          password = "Infyme@25011998"
          role = "ACCOUNTADMIN"
          database = "DEVOPS"
          warehouse = "COMPUTE_WH"
          EOF
          chmod 600 ~/.snowflake/config.toml

      - name: Deploy tables
        run: |
          echo "Deploying tables..."
          if [[ "$DEPLOY_ALL" == "true" ]]; then
            find schemas -type f -path "*/tables/*.sql" | sort | while read file; do
              echo "Deploying $file"
              snow sql -f "$file" --connection default
            done
          else
            grep 'tables/' changed_files.txt | while read file; do
              echo "Deploying changed table: $file"
              snow sql -f "$file" --connection default
            done
          fi

      - name: Deploy views
        run: |
          echo "Deploying views..."
          if [[ "$DEPLOY_ALL" == "true" ]]; then
            find schemas -type f -path "*/views/*.sql" | sort | while read file; do
              echo "Deploying $file"
              snow sql -f "$file" --connection default
            done
          else
            grep 'views/' changed_files.txt | while read file; do
              echo "Deploying changed view: $file"
              snow sql -f "$file" --connection default
            done
          fi

      - name: Deploy other SQL objects (functions, procedures, etc)
        run: |
          echo "Deploying other objects..."
          if [[ "$DEPLOY_ALL" == "true" ]]; then
            find schemas -type f -name "*.sql" ! -path "*/tables/*" ! -path "*/views/*" | sort | while read file; do
              echo "Deploying $file"
              snow sql -f "$file" --connection default
            done
          else
            grep -vE 'tables/|views/' changed_files.txt | while read file; do
              echo "Deploying changed object: $file"
              snow sql -f "$file" --connection default
            done
          fi
