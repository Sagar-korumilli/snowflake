name: Deploy to Snowflake

on:
  push:
    branches:
      - main
      - release
      - dev
      - master
  pull_request:
    branches:
      - main
      - release
      - dev
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # required for full git history to do proper diff

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install SnowCLI
        run: |
          pip install --user snowflake-cli
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure SnowCLI
        run: |
          mkdir -p ~/.snowflake
          cat << EOF > ~/.snowflake/config.toml
          [connections.default]
          account = "iiljdbv-rv91789"
          user = "SAGARK"
          password = "Infyme@25011998"
          role = "ACCOUNTADMIN"
          database = "DEVOPS"
          warehouse = "COMPUTE_WH"
          EOF
          chmod 600 ~/.snowflake/config.toml

      - name: Test Snowflake connection
        run: snow connection test --connection default

      - name: Detect changed SQL files
        id: detect_changes
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE=${{ github.event.pull_request.base.ref }}
            HEAD=${{ github.event.pull_request.head.ref }}
          else
            BASE=${{ github.ref_name }}
            HEAD=HEAD
          fi

          echo "Base branch: $BASE"
          echo "Head ref: $HEAD"

          git fetch origin $BASE
          git fetch origin $HEAD

          CHANGED_FILES=$(git diff --name-only origin/$BASE...origin/$HEAD | grep '\.sql$' || true)

          if [[ -z "$CHANGED_FILES" ]]; then
            echo "No .sql file changes found. Deploying all."
            echo "DEPLOY_ALL=true" >> $GITHUB_ENV
          else
            echo "Found changed SQL files:"
            echo "$CHANGED_FILES"
            echo "$CHANGED_FILES" > changed_files.txt
            echo "DEPLOY_ALL=false" >> $GITHUB_ENV
          fi

      - name: Deploy schemas creation script (always)
        run: |
          if [ -f "scripts/create_schemas.sql" ]; then
            echo "Deploying schemas..."
            snow sql -f scripts/create_schemas.sql --connection default
          fi

      - name: Deploy changed or all SQL files
        run: |
          if [[ "$DEPLOY_ALL" == "true" ]]; then
            echo "Deploying all SQL files under schemas/..."
            find schemas -type f -name "*.sql" | sort | while read file; do
              echo "Deploying $file"
              snow sql -f "$file" --connection default
            done
          else
            echo "Deploying only changed SQL files..."
            while read file; do
              if [[ -f "$file" ]]; then
                echo "Deploying $file"
                snow sql -f "$file" --connection default
              else
                echo "File $file no longer exists. Skipping."
              fi
            done < changed_files.txt
          fi
